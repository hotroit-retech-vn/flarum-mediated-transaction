(()=>{var t={n:n=>{var r=n&&n.__esModule?()=>n.default:()=>n;return t.d(r,{a:r}),r},d:(n,r)=>{for(var e in r)t.o(r,e)&&!t.o(n,e)&&Object.defineProperty(n,e,{enumerable:!0,get:r[e]})},o:(t,n)=>Object.prototype.hasOwnProperty.call(t,n)};(()=>{"use strict";const n=flarum.core.compat["common/app"];t.n(n)().initializers.add("retechvn/mediated-transaction",(function(){console.log("[retechvn/mediated-transaction] Hello, forum and admin!")}));const r=flarum.core.compat["forum/app"];var e=t.n(r);const a=flarum.core.compat["components/LinkButton"];var o=t.n(a);const i=flarum.core.compat["common/extend"],s=flarum.core.compat["components/IndexPage"];var c=t.n(s);function u(t,n){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,n){return t.__proto__=n,t},u(t,n)}function h(t,n){t.prototype=Object.create(n.prototype),t.prototype.constructor=t,u(t,n)}const l=flarum.core.compat["common/components/Page"];var d=t.n(l);const v=flarum.core.compat["helpers/listItems"];var p=t.n(v);const _=flarum.core.compat["components/Button"];var f=t.n(_);const g=flarum.core.compat["common/components/Alert"];var y=t.n(g);const b=flarum.core.compat["components/Modal"];var C=t.n(b);const w=flarum.core.compat.app;var T=t.n(w),x=function(t){function n(){return t.apply(this,arguments)||this}h(n,t);var r=n.prototype;return r.oninit=function(n){t.prototype.oninit.call(this,n)},r.title=function(){return"Thanh Toán Giao Dịch"},r.content=function(){return m(".Modal-body .row",[m(".Form-group",{style:"width: 100%; text-align: center;"},[m("a",{href:"https://me-qr.com",style:"cursor:pointer;display:block",border:"0"},[m("img",{src:"https://cdn2.me-qr.com/qr/129980334.png?v=1728835376",alt:"Create QR code for free"})])]),m(".Form-group ",{style:"width: 100%;"},[f().component({type:"submit",className:"Button Button--primary Button--block"},"Tiếp tục tạo giao dịch")])])},r.onsubmit=function(t){t.preventDefault(),this.attrs.onsubmit(!0),T().modal.close()},n}(C()),N=function(t){function n(){return t.apply(this,arguments)||this}h(n,t);var r=n.prototype;return r.oninit=function(n){t.prototype.oninit.call(this,n),this.loading=!0,this.user_current=e().session.user,this.initializeData(),this.resultsUser=[],this.showDropdown=!1,this.handleClickOutside=this.handleClickOutside.bind(this)},r.initializeData=function(){this.data={rvn_creator_id:this.user_current.data.id,rvn_receiver_id:"",rvn_amount:0,rvn_fee:.1,rvn_payer_id:this.user_current.data.id,rvn_note:""},this.rvn_creator_name=e().session.user.username(),this.rvn_receiver_name="",this.rvn_service_fee=0,this.rvn_total_amount=0,this.rvn_receiver_name_search="",this.rvn_receiver_name_select=""},r.oncreate=function(n){t.prototype.oncreate.call(this,n),e().setTitle("Giao dịch trung gian"),e().setTitleCount(0),document.addEventListener("click",this.handleClickOutside)},r.onremove=function(){document.removeEventListener("click",this.handleClickOutside)},r.view=function(){return m(".IndexPage",[c().prototype.hero(),m(".container",[m(".sideNavContainer",[this.renderSidebar(),this.renderForm()])])])},r.renderSidebar=function(){return m("nav.IndexPage-nav.sideNav",m("ul",p()(c().prototype.sidebarItems().toArray())))},r.renderForm=function(){var t=this;return m(".IndexPage-results.sideNavOffset",[m("div.retechvn__text-center",m("h2","Giao dịch trung gian")),m(".Modal-body.rvn__body-form .row",[this.renderInput("Tên đồ án","Nhập tên đồ án",this.rvn_creator_name+(""!=this.rvn_receiver_name?"__"+this.rvn_receiver_name:""),!0),this.renderReceiverInput("Tên đối tác","Nhập tên đối tác cần tìm kiếm"),this.renderNumberInput("Tiền thuê",this.data.rvn_amount,this.handleRentChange.bind(this)),this.renderInput("Phí dịch vụ ("+100*this.data.rvn_fee+"%)","",this.rvn_service_fee,!0),this.renderRadioGroup("Người trả phí","Bạn trả phí","Đối tác trả phi"),this.renderInput("Tổng tiền bạn phải trả","",this.rvn_total_amount,!0),this.renderTextarea("Ghi chú",this.data.rvn_note,(function(n){return t.data.rvn_note=n.target.value})),this.renderCheckbox(),this.renderSubmitButton()])])},r.renderInput=function(t,n,r,e){return void 0===e&&(e=!1),m(".Form-group.col.col-md-6",[m("label",t),m("input.FormControl",{value:r,disabled:e,placeholder:n})])},r.renderReceiverInput=function(t,n){var r=this;return m(".Form-group.position-relative.col.col-md-6",[m("label",[t,m("span",{className:this.data.rvn_receiver_id?"rvn__text-green":"rvn__text-red"},this.data.rvn_receiver_id?" ("+this.rvn_receiver_name_select+")":" (Chưa chọn)")]),m("input.FormControl",{value:this.rvn_receiver_name_search,placeholder:n,onfocus:function(){return r.showDropdown=!0},onkeyup:function(t){r.rvn_receiver_name_search=t.target.value,setTimeout((function(){return r.search(t.target.value)}),100)}}),this.showDropdown&&this.renderDropdown()])},r.renderDropdown=function(){return m(".search-results",this.resultsUser.length?this.resultsUser.map(this.renderDropdownItem.bind(this)):m("div.no-results.rvn__mx2","Không có dữ liệu"))},r.renderDropdownItem=function(t){var n=this;return m("div.search-result-item",{onclick:function(){return n.selectReceiver(t)}},[t.avatarUrl()?m("img.Avatar.rvn__avatar",{src:t.avatarUrl(),alt:t.displayName()}):m("span.Avatar.rvn__avatar",{style:this.avatarStyle(t)},t.displayName().charAt(0).toUpperCase()),m("span.username","  "+t.displayName()+" ("+t.username()+")")])},r.renderNumberInput=function(t,n,r){return m(".Form-group.col.col-md-6",[m("label",t+" ("+this.formatCurrency(n)+")"),m("input[type=number].FormControl",{value:n,onchange:r})])},r.renderRadioGroup=function(t,n,r){return m(".Form-group.col.col-md-6",[m("label",t),m(".radio-group",[this.renderRadioOption(n,this.data.rvn_creator_id,this.rvn_creator_name,this.data.rvn_payer_id==this.data.rvn_creator_id),this.renderRadioOption(r,this.data.rvn_receiver_id,this.rvn_receiver_name,this.data.rvn_payer_id==this.data.rvn_receiver_id,!this.data.rvn_receiver_id)])])},r.renderRadioOption=function(t,n,r,e,a){var o=this;return void 0===a&&(a=!1),m("label",[m("input[type=radio]",{name:"fee_payer",value:n,checked:e,disabled:a,onchange:function(t){return o.handleFeePayerChange(t)}})," "+t+" ("+r+")"])},r.renderTextarea=function(t,n,r){return m(".Form-group.col.col-12.rvn_note",[m("label",t),m("textarea.FormControl",{value:n,onchange:r})])},r.renderCheckbox=function(){var t=this;return m(".Form-group.col",[m("label",[m("input[type=checkbox]",{checked:this.isChecked,onchange:function(n){return t.isChecked=n.target.checked}})," Đồng ý với điều khoản và điều kiện!"])])},r.renderSubmitButton=function(){var t=this;return m(".Form-group.col.col-12",[f().component({type:"button",className:"Button Button--primary Button--block",onclick:function(n){return t.onsubmit(n)}},"Tạo giao dịch")])},r.handleRentChange=function(t){this.data.rvn_amount=+t.target.value,this.calculateTotal()},r.handleFeePayerChange=function(t){this.data.rvn_payer_id=t.target.value,this.calculateTotal()},r.selectReceiver=function(t){this.rvn_receiver_name=t.username(),this.rvn_receiver_name_search="",this.rvn_receiver_name_select=t.displayName()+" ("+t.username()+")",this.data.rvn_receiver_id=t.data.id,this.showDropdown=!1},r.avatarStyle=function(t){return{"--avatar-bg":t.color(),"font-size":"20px"}},r.validateForm=function(){for(var t=this.data,n=0,r=[[!t.rvn_receiver_id,"Chưa chọn tên đối tác."],[t.rvn_amount<=0,"Tiền thuê phải lớn hơn 0."],[!t.rvn_fee,"Phí dịch vụ không hợp lệ."],[!t.rvn_payer_id,"Người trả phí chưa được chọn."],[!this.isChecked,"Bạn phải đồng ý với điều khoản và điều kiện."]];n<r.length;n++){var e=r[n],a=e[0],o=e[1];if(a)return this.showAlert("error",o,5e3),!1}return!0},r.formatCurrency=function(t){return(+t).toLocaleString("vi-VN",{style:"currency",currency:"VND",minimumFractionDigits:0,maximumFractionDigits:0})},r.calculateTotal=function(){var t=+this.data.rvn_amount||0,n=.1*t;this.rvn_service_fee=this.formatCurrency(n),this.rvn_total_amount=this.formatCurrency(this.data.rvn_payer_id==this.data.rvn_creator_id?t+n:t)},r.search=function(t){var n=this;t.trim()?e().store.find("users",{filter:{q:t}}).then((function(t){n.resultsUser=t.filter((function(t){return t.data.id!=n.user_current.id()})),n.showDropdown=!0})):(this.resultsUser=[],this.showDropdown=!1)},r.handleClickOutside=function(t){t.target.closest(".FormControl")||t.target.closest(".search-results")||(this.showDropdown=!1,m.redraw())},r.showAlert=function(t,n,r){void 0===t&&(t="success"),void 0===n&&(n=""),void 0===r&&(r=5e3),e().alerts.show(y(),{type:t},n),setTimeout((function(){e().alerts.clear()}),r)},r.onsubmit=function(t){var n=this;t.preventDefault(),this.loading=!0;var r={rvn_creator_id:Number(this.data.rvn_creator_id),rvn_receiver_id:Number(this.data.rvn_receiver_id),rvn_amount:Number(this.data.rvn_amount),rvn_fee:this.data.rvn_fee,rvn_payer_id:Number(this.data.rvn_payer_id),rvn_note:this.data.rvn_note};console.log(r),e().modal.show(x,{onsubmit:function(t){console.log(t),e().request({method:"POST",url:e().forum.attribute("apiUrl")+"/transactions",body:{data:r}}).then((function(t){console.log(t),n.showAlert("success","Tạo giao dịch thành công!",5e3),n.initializeData(),n.loading=!1})).catch((function(t){console.log(t),n.showAlert("error","Có lỗi xảy ra. Vui lòng thử lại!",5e3),n.loading=!1}))}})},n}(d());const k=flarum.core.compat["forum/components/HeaderSecondary"];var D=t.n(k);const I=flarum.core.compat["components/UserPage"];var R=t.n(I);const B=flarum.core.compat.Component;var F=t.n(B);const P=flarum.core.compat["components/LoadingIndicator"];var U=t.n(P);const O=flarum.core.compat["common/components/Dropdown"];var H=t.n(O),L=function(t){function n(){return t.apply(this,arguments)||this}h(n,t);var r=n.prototype;return r.oninit=function(n){t.prototype.oninit.call(this,n),this.transId=this.attrs.transId,this.currentUserId=this.attrs.userId,this.loading=!0,this.moreResults=!1,this.tranlogs=[],this.statusText={1:"Đang xử lý",2:"Thành công",3:"Kiếu nại",4:"Đã hủy"},console.log(this.attrs),this.loadData(this.transId)},r.parseResults=function(t){return this.moreResults=!!t.payload.links&&!!t.payload.links.next,[].push.apply(this.tranlogs,t.payload.data),this.loading=!1,m.redraw(),t},r.loadData=function(t,n){void 0===n&&(n=0),T().store.find("transaction-logs",{filter:{transactionId:t},page:{offset:n}}).catch((function(){})).then(this.parseResults.bind(this))},r.title=function(){return"Chi tiết giao dịch"},r.content=function(){var t=this;return this.loading?m("div",{className:"Modal-body"},U().component({size:"large"})):m("div",{className:"Modal-body sideNavContainer"},m("table",{className:"TransactionLogsTable rvn__table"},m("thead",{class:"rvn__thead"},m("tr",{class:"rvn__tr"},m("th",{class:"rvn__th"},"STT"),m("th",{class:"rvn__th"},"Trạng thái"),m("th",{class:"rvn__th"},"Lý do"),m("th",{class:"rvn__th"},"Ngày cập nhật"))),m("tbody",{class:"rvn__tbody"},this.tranlogs.length?this.tranlogs.map((function(n,r){return m("tr",{key:n.id,class:"rvn__tr"},m("td",{class:"rvn__th"},r+1),m("td",{class:"rvn__th"},t.showText(t.currentUserId,n.attributes.creator,n.attributes.rvn_status,n.attributes.transaction)),m("td",{class:"rvn__th"},n.attributes.rvn_reason||"N/A"),m("td",{class:"rvn__th"},n.attributes.updated_at))})):m("tr",null,m("td",{class:"rvn__th",colSpan:"6"},"Không có dữ liệu")))))},r.showText=function(t,n,r,e){var a="";return 1==r&&(a=n.username+" đã tạo giao dịch"),2==r&&(a=n.username+" đã hoàn thành giao dịch"),3==r&&(a=n.username+" đã gửi khiếu nại"),4==r&&(a=n.username+" đã hủy giao dịch"),a},r.onsubmit=function(t){t.preventDefault()},r.className=function(){return"DetailTransactionModal"},n}(C()),S=function(t){function n(){return t.apply(this,arguments)||this}h(n,t);var r=n.prototype;return r.oninit=function(n){t.prototype.oninit.call(this,n),this.transId=this.attrs.transId,console.log(this.attrs)},r.loadData=function(t){},r.title=function(){return"Hủy giao dịch"},r.content=function(){return m(".Modal-body .row",m("p",null," sdas"))},r.onsubmit=function(t){t.preventDefault()},r.className=function(){},n}(C()),M=function(t){function n(){return t.apply(this,arguments)||this}h(n,t);var r=n.prototype;return r.oninit=function(n){t.prototype.oninit.call(this,n),this.loading=!0,this.moreResults=!1,this.transactionHistory=[],this.user=this.attrs.params.user,this.statusText={1:"Đang xử lý",2:"Thành công",3:"Kiếu nại",4:"Đã hủy"},this.loadResults()},r.view=function(){var t=this;return this.loading&&U().component({size:"large"}),m("div",null,m("div",{style:"padding-bottom:10px; font-size: 24px;font-weight: bold;"},"Lịch sử giao dịch"),m("div",{class:"sideNavContainer"},m("table",{class:"rvn__table"},m("thead",{class:"rvn__thead"},m("tr",{class:"rvn__tr"},m("th",{class:"rvn__th"},"STT"),m("th",{class:"rvn__th"},"Tên đồ án"),m("th",{class:"rvn__th"},"Tên thợ"),m("th",{class:"rvn__th"},"Tiền thuê"),m("th",{class:"rvn__th"},"Phí"),m("th",{class:"rvn__th"},"Người trả phí"),m("th",{class:"rvn__th"},"Tổng tiền"),m("th",{class:"rvn__th"},"Trạng thái"),m("th",{class:"rvn__th"},"Ngày tạo"),m("th",{class:"rvn__th",style:"width:100px;"},"Chi tiết"))),m("tbody",{class:"rvn__tbody"},this.transactionHistory.map((function(n,r){return m("tr",{class:"rvn__tr",key:n.id,"data-id":n.id},m("td",{class:"rvn__td"},r+1),m("td",{class:"rvn__td"},n.attributes.creator.username+"__"+n.attributes.receiver.username),m("td",{class:"rvn__td"},n.attributes.receiver.username),m("td",{class:"rvn__td"},t.formatCurrency(n.attributes.rvn_amount)),m("td",{class:"rvn__td"},100*n.attributes.rvn_fee,"%"),m("td",{class:"rvn__td"},n.attributes.rvn_payer_id==n.attributes.rvn_receiver_id?n.attributes.receiver.username:n.attributes.creator.username),m("td",{class:"rvn__td"},t.formatCurrency(n.attributes.rvn_amount+n.attributes.rvn_amount*n.attributes.rvn_fee)),m("td",{class:"rvn__td"},t.statusText[n.attributes.latest_log_status]),m("td",{class:"rvn__td"},n.attributes.created_at),m("td.rvn__td",m(H(),{className:"User-controls",buttonClassName:"Button Button--icon Button--flat",menuClassName:"Dropdown-menu--right",icon:"fas fa-ellipsis-h"},[m("button.Button.UserList-detailBtn",{title:"Xem chi tiết",onclick:function(){return T().modal.show(L,{transId:n.id,userId:t.user.id()})}},["Xem chi tiết"]),1==n.attributes.latest_log_status?m("button.Button.UserList-confirmBtn",{title:"Hoàn thành",onclick:function(){return T().modal.show(L)}},["Hoàn thành"]):"",1==n.attributes.latest_log_status?m("button.Button.UserList-cancelBtn",{title:"Hủy",onclick:function(){return T().modal.show(S)}},["Hủy"]):"",1==n.attributes.latest_log_status?m("button.Button.UserList-complaintsBtn",{title:"Khiếu nại",onclick:function(){return T().modal.show(S)}},["Khiếu nại"]):""])))}))))))},r.loadMore=function(){this.loading=!0,this.loadResults(this.transactionHistory.length)},r.showPrice=function(t,n,r,e,a){return n==t&&t==r?this.formatCurrency(a*e):n==t&&t!=r?this.formatCurrency(0):n!=t&&t==r?this.formatCurrency(e+a*e):this.formatCurrency(e)},r.caculator=function(t,n,r){return void 0===r&&(r=!1),r?this.formatCurrency(t+n*t):this.formatCurrency(n*t)},r.formatCurrency=function(t){return(+t).toLocaleString("vi-VN",{style:"currency",currency:"VND",minimumFractionDigits:0,maximumFractionDigits:0})},r.parseResults=function(t){return this.moreResults=!!t.payload.links&&!!t.payload.links.next,[].push.apply(this.transactionHistory,t.payload.data),this.loading=!1,m.redraw(),t},r.hasMoreResults=function(){return this.moreResults},r.loadResults=function(t){return void 0===t&&(t=0),T().store.find("transactions",{filter:{user:this.user.id()},page:{offset:t}}).catch((function(){})).then(this.parseResults.bind(this))},n}(F()),A=function(t){function n(){return t.apply(this,arguments)||this}h(n,t);var r=n.prototype;return r.oninit=function(n){t.prototype.oninit.call(this,n),this.loadUser(m.route.param("username"))},r.content=function(){return m("div",{className:"TransferHistoryPage"},M.component({params:{user:this.user}}))},n}(R());const z=flarum.core.compat["components/Notification"];var G=t.n(z);flarum.core.compat["common/helpers/username"];var j=function(t){function n(){return t.apply(this,arguments)||this}h(n,t);var r=n.prototype;return r.icon=function(){return"fas fa-exchange-alt"},r.href=function(){return e().route.transaction(this.attrs.notification.subject())},r.content=function(){return e().translator.trans("retechvn-mediated-transaction.forum.notifications.transaction_created_text",{user:this.attrs.notification.fromUser(),transaction:this.attrs.notification.subject()})},n}(G());const K=flarum.core.compat["components/NotificationGrid"];var q=t.n(K);e().initializers.add("retechvn/mediated-transaction",(function(){e().routes.transactionPage={path:"/giao-dich-trung-gian",component:N},e().routes["user.transactionHistoryPage"]={path:"/u/:username/lich-su-giao-dich",component:A},e().notificationComponents.transactionCreated=j,(0,i.extend)(q().prototype,"notificationTypes",(function(t){t.add("transactionCreated",{name:"transactionCreated",icon:"fas fa-exchange-alt",label:e().translator.trans("retechvn-mediated-transaction.forum.notifications.transaction_created_label")})})),(0,i.extend)(c().prototype,"navItems",(function(t){e().session&&e().session.user&&e().session.user&&t.add("transactionPage",m(o(),{href:e().route("transactionPage"),icon:"fas fa-magic"},"Giao dịch trung gian"),100)})),(0,i.extend)(D().prototype,"items",(function(t){e().session&&e().session.user&&e().session.user&&t.add("techcoin",m("span.rvn__text-piece",[m("i.fas.fa-coins")," "+e().session.user.attribute("rvn_point")+" RTC"]),15)})),(0,i.extend)(R().prototype,"navItems",(function(t,n){e().session&&e().session.user&&e().session.user.id()==this.user.id()&&t.add("transactionMoney",o().component({href:e().route("user.transactionHistoryPage",{username:this.user.username()}),icon:"fas fa-money-bill"},["Lịch sử giao dịch"]),10)}))}))})(),module.exports={}})();
//# sourceMappingURL=forum.js.map